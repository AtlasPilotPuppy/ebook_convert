name: Release

on:
  push:
    tags:
      - "v*"

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64
            target: x86_64-unknown-linux-gnu
            binary: ebook-convert-rs
            archive: ebook-convert-rs-linux-x86_64.tar.gz
            cross-pkgs: ""
          - name: linux-aarch64
            target: aarch64-unknown-linux-gnu
            binary: ebook-convert-rs
            archive: ebook-convert-rs-linux-aarch64.tar.gz
            cross-pkgs: gcc-aarch64-linux-gnu
          - name: windows-x86_64
            target: x86_64-pc-windows-gnu
            binary: ebook-convert-rs.exe
            archive: ebook-convert-rs-windows-x86_64.zip
            cross-pkgs: mingw-w64
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation toolchain
        if: matrix.cross-pkgs != ''
        run: |
          sudo apt-get update
          sudo apt-get install -y ${{ matrix.cross-pkgs }}

      - name: Configure cross-linkers
        if: matrix.cross-pkgs != ''
        shell: bash
        run: |
          mkdir -p ebook-convert-rs/.cargo
          printf '[target.aarch64-unknown-linux-gnu]\nlinker = "aarch64-linux-gnu-gcc"\n\n[target.x86_64-pc-windows-gnu]\nlinker = "x86_64-w64-mingw32-gcc"\nar = "x86_64-w64-mingw32-ar"\n' >> ebook-convert-rs/.cargo/config.toml

      - name: Build release binary
        working-directory: ebook-convert-rs
        run: cargo build --target ${{ matrix.target }} --release

      - name: Package (tar.gz)
        if: "!contains(matrix.archive, '.zip')"
        run: |
          cd ebook-convert-rs/target/${{ matrix.target }}/release
          tar czf ${{ matrix.archive }} ${{ matrix.binary }}
          mv ${{ matrix.archive }} ../../../../

      - name: Package (zip)
        if: contains(matrix.archive, '.zip')
        run: |
          cd ebook-convert-rs/target/${{ matrix.target }}/release
          zip ${{ matrix.archive }} ${{ matrix.binary }}
          mv ${{ matrix.archive }} ../../../../

      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.archive }}
          path: ${{ matrix.archive }}
          retention-days: 1

  release:
    name: Publish Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts

      - name: Flatten artifacts
        run: |
          mkdir -p release-files
          find artifacts -type f \( -name "*.tar.gz" -o -name "*.zip" \) -exec mv {} release-files/ \;
          ls -lh release-files/

      - name: Generate release notes
        id: notes
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          PREV_TAG=$(git tag --sort=-v:refname | grep -v "^${TAG}$" | head -1 || echo "")

          {
            echo "notes<<NOTES_EOF"

            if [ -n "$PREV_TAG" ]; then
              echo "## Changes since ${PREV_TAG}"
              echo ""
              git log "${PREV_TAG}..${TAG}" --pretty=format:"- %s" --no-merges
            else
              echo "## Initial Release"
              echo ""
              git log --pretty=format:"- %s" --no-merges -20
            fi

            echo ""
            echo ""
            echo "## Platform Binaries"
            echo ""
            echo "| Platform | Archive |"
            echo "|----------|---------|"
            echo "| Linux x86_64 | \`ebook-convert-rs-linux-x86_64.tar.gz\` |"
            echo "| Linux aarch64 | \`ebook-convert-rs-linux-aarch64.tar.gz\` |"
            echo "| Windows x86_64 | \`ebook-convert-rs-windows-x86_64.zip\` |"
            echo ""
            echo "macOS binaries are available from [GitHub Releases](https://github.com/AtlasPilotPuppy/ebook_convert/releases)."
            echo ""
            echo "### Requirements"
            echo ""
            echo "The PDF input plugin requires [poppler-utils](https://poppler.freedesktop.org/) (\`pdftohtml\`, \`pdftoppm\`) installed on your system. All other formats use pure Rust with no external dependencies."

            echo "NOTES_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create Forgejo Release
        uses: https://code.forgejo.org/actions/forgejo-release@v2.6.0
        with:
          direction: upload
          url: ${{ github.server_url }}
          token: ${{ secrets.RELEASE_TOKEN }}
          tag: ${{ github.ref_name }}
          title: ${{ github.ref_name }}
          release-dir: release-files
          release-notes: ${{ steps.notes.outputs.notes }}
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
