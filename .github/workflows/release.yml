name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: linux-x86_64
            os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary: ebook-convert-rs
            archive: ebook-convert-rs-linux-x86_64.tar.gz
          - name: windows-x86_64
            os: windows-latest
            target: x86_64-pc-windows-msvc
            binary: ebook-convert-rs.exe
            archive: ebook-convert-rs-windows-x86_64.zip
          - name: macos-x86_64
            os: macos-latest
            target: x86_64-apple-darwin
            binary: ebook-convert-rs
            archive: ebook-convert-rs-macos-x86_64.tar.gz
          - name: macos-aarch64
            os: macos-latest
            target: aarch64-apple-darwin
            binary: ebook-convert-rs
            archive: ebook-convert-rs-macos-aarch64.tar.gz
    steps:
      - name: Configure git line endings
        if: runner.os == 'Windows'
        run: git config --global core.autocrlf input

      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: "ebook-convert-rs -> ebook-convert-rs/target"
          shared-key: "release-${{ matrix.name }}"

      - name: Build release binary
        working-directory: ebook-convert-rs
        run: cargo build --target ${{ matrix.target }} --release

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          cd ebook-convert-rs/target/${{ matrix.target }}/release
          tar czf ${{ matrix.archive }} ${{ matrix.binary }}
          mv ${{ matrix.archive }} ../../../../

      - name: Package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd ebook-convert-rs/target/${{ matrix.target }}/release
          Compress-Archive -Path ${{ matrix.binary }} -DestinationPath ${{ matrix.archive }}
          Move-Item ${{ matrix.archive }} ../../../../

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.archive }}
          path: ${{ matrix.archive }}
          retention-days: 1

  release:
    name: Publish Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: List artifacts
        run: ls -lh artifacts/

      - name: Generate release notes
        id: notes
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          PREV_TAG=$(git tag --sort=-v:refname | grep -v "^${TAG}$" | head -1 || echo "")

          {
            echo "notes<<NOTES_EOF"

            if [ -n "$PREV_TAG" ]; then
              echo "## Changes since ${PREV_TAG}"
              echo ""
              git log "${PREV_TAG}..${TAG}" --pretty=format:"- %s" --no-merges
            else
              echo "## Initial Release"
              echo ""
              git log --pretty=format:"- %s" --no-merges -20
            fi

            echo ""
            echo ""
            echo "## Platform Binaries"
            echo ""
            echo "| Platform | Archive |"
            echo "|----------|---------|"
            echo "| Linux x86_64 | \`ebook-convert-rs-linux-x86_64.tar.gz\` |"
            echo "| Windows x86_64 | \`ebook-convert-rs-windows-x86_64.zip\` |"
            echo "| macOS x86_64 (Intel) | \`ebook-convert-rs-macos-x86_64.tar.gz\` |"
            echo "| macOS aarch64 (Apple Silicon) | \`ebook-convert-rs-macos-aarch64.tar.gz\` |"
            echo ""
            echo "### Requirements"
            echo ""
            echo "The PDF input plugin requires [poppler-utils](https://poppler.freedesktop.org/) (\`pdftohtml\`, \`pdftoppm\`) installed on your system. All other formats use pure Rust with no external dependencies."

            echo "NOTES_EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ github.ref_name }}
          body: ${{ steps.notes.outputs.notes }}
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          files: artifacts/*
          fail_on_unmatched_files: true
